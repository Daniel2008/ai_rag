# 跨语言检索功能说明

## 🎯 问题描述

当知识库中包含英文文档，但用户使用中文提问时，传统的向量检索可能无法准确匹配到相关文档。这是因为：

1. **语言不匹配**：中文查询和英文文档在向量空间中的距离较远
2. **语义理解局限**：单语言嵌入模型对跨语言语义的理解有限
3. **检索准确率低**：导致无法命中相关的英文文档

## ✨ 解决方案

### 1. 自动查询翻译

系统会自动检测查询语言：
- 如果检测到**中文查询**，会自动将查询翻译成**英文**
- 同时使用**原始查询**和**翻译后的查询**进行检索
- 合并结果并去重，保留最相关的文档

### 2. 多语言嵌入模型

默认使用 `multilingual-e5-small` 多语言嵌入模型，该模型：
- 支持 100+ 种语言
- 对跨语言语义有更好的理解
- 能够将不同语言的相似概念映射到相近的向量空间

### 3. 混合检索策略

检索过程：
1. **原始查询检索**：使用用户输入的原始查询进行向量检索
2. **翻译查询检索**：如果检测到中文查询，使用翻译后的英文查询进行检索
3. **结果合并**：合并两次检索的结果，按相似度排序
4. **去重优化**：去除重复文档，保留相似度最高的版本

## 📋 使用方法

### 自动启用

跨语言检索功能**自动启用**，无需额外配置。当系统检测到：
- 查询是中文
- 知识库中包含英文文档

会自动触发跨语言检索流程。

### 配置嵌入模型

推荐使用多语言嵌入模型以获得最佳效果：

1. 打开**设置**
2. 选择**嵌入模型** → **本地模型**
3. 选择 `multilingual-e5-small`（默认已选择）

### 支持的模型

| 模型 | 类型 | 跨语言支持 | 推荐度 |
|------|------|-----------|--------|
| `multilingual-e5-small` | 多语言 | ✅ 优秀 | ⭐⭐⭐⭐⭐ |
| `nomic-embed-text` | 英文为主 | ⚠️ 有限 | ⭐⭐⭐ |
| `bge-small-zh` | 中文为主 | ⚠️ 有限 | ⭐⭐ |
| `all-MiniLM-L6` | 英文为主 | ❌ 不支持 | ⭐ |

## 🔍 工作原理

### 查询流程

```
用户输入中文查询
    ↓
检测语言（中文）
    ↓
翻译成英文（使用 LLM）
    ↓
并行检索：
  - 原始中文查询 → 向量检索
  - 翻译英文查询 → 向量检索
    ↓
合并结果并去重
    ↓
返回最相关的文档
```

### 示例

**场景**：知识库包含英文文档 "Introduction to Machine Learning"

**查询 1**（中文）：
```
什么是机器学习？
```

**处理过程**：
1. 检测到中文查询
2. 翻译为：`What is machine learning?`
3. 使用两个查询进行检索：
   - `什么是机器学习？`（原始）
   - `What is machine learning?`（翻译）
4. 合并结果，成功匹配到英文文档

**查询 2**（英文）：
```
What is machine learning?
```

**处理过程**：
1. 检测到英文查询
2. 直接使用原始查询检索
3. 无需翻译

## ⚙️ 技术细节

### 语言检测

使用简单的字符检测算法：
- 检测中文字符（Unicode 范围：\u4e00-\u9fa5）
- 检测英文字符（a-zA-Z）
- 如果同时包含中英文，根据字符数量比例判断主要语言

### 查询翻译

使用配置的 LLM 进行翻译：
- 支持所有已配置的 LLM 提供商（OpenAI、Ollama、Anthropic 等）
- 翻译提示词优化，确保只返回翻译结果
- 翻译失败时自动回退到原始查询

### 结果去重

基于文档内容进行去重：
- 使用文档文本内容作为唯一标识
- 保留相似度最高（距离最小）的版本
- 确保结果中不包含重复文档

## 🐛 故障排除

### Q: 翻译功能不工作

**A**: 检查以下配置：
1. 确保已配置 LLM（OpenAI、Ollama 等）
2. 检查 LLM API Key 是否正确
3. 查看控制台日志，确认翻译是否成功

### Q: 仍然无法匹配英文文档

**A**: 尝试以下方法：
1. **切换嵌入模型**：使用 `multilingual-e5-small`
2. **重建索引**：切换模型后需要重建索引
3. **检查文档质量**：确保英文文档内容完整、清晰
4. **调整查询**：尝试使用更具体的关键词

### Q: 翻译速度慢

**A**: 
1. 使用本地 LLM（Ollama）可以加快翻译速度
2. 翻译结果会被缓存（在同一会话中）
3. 如果翻译失败，会自动回退到原始查询

### Q: 如何禁用跨语言检索

**A**: 目前不支持完全禁用，但可以通过以下方式减少使用：
1. 使用单语言嵌入模型（如 `bge-small-zh` 仅中文）
2. 确保查询和文档使用相同语言

## 💡 最佳实践

1. **使用多语言模型**：推荐 `multilingual-e5-small`
2. **混合语言知识库**：可以同时包含中英文文档
3. **自然提问**：使用自然语言提问，系统会自动处理
4. **重建索引**：切换嵌入模型后记得重建索引

## 📊 性能影响

- **额外延迟**：翻译查询会增加约 0.5-2 秒延迟（取决于 LLM 响应速度）
- **检索质量**：跨语言检索可以显著提高英文文档的召回率
- **资源消耗**：需要额外的 LLM API 调用（如果使用云端 LLM）

## 🔮 未来改进

- [ ] 支持更多语言对（如英文→中文）
- [ ] 查询翻译结果缓存
- [ ] 可配置的跨语言检索开关
- [ ] 更智能的语言检测算法
- [ ] 支持多语言混合查询

